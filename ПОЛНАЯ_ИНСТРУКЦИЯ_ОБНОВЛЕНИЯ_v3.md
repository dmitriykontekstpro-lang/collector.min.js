# üöÄ –ü–û–õ–ù–ê–Ø –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –û–ë–ù–û–í–õ–ï–ù–ò–Æ (–í–µ—Ä—Å–∏—è 3.0: Single Table)

–ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–Ω—É—é —Å—Ö–µ–º—É —Å –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π. –≠—Ç–æ –±—ã—Å—Ç—Ä–µ–µ, –Ω–∞–¥–µ–∂–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.

---

## 1Ô∏è‚É£ –®–ê–ì 1: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (Supabase)

–ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É `analytics` –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–µ—Ö.

1.  –û—Ç–∫—Ä–æ–π—Ç–µ **Supabase** ‚Üí –ü—Ä–æ–µ–∫—Ç `qqfyjrugrinmdijpsutj` ‚Üí **SQL Editor**.
2.  –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π Query.
3.  –í—Å—Ç–∞–≤—å—Ç–µ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥:

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
CREATE TABLE IF NOT EXISTS analytics (
  id BIGSERIAL PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  event_name TEXT NOT NULL,
  user_id TEXT,
  session_id TEXT,
  page_url TEXT,
  data JSONB DEFAULT '{}'::jsonb
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
CREATE INDEX IF NOT EXISTS idx_analytics_created_at ON analytics(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_analytics_event_name ON analytics(event_name);
CREATE INDEX IF NOT EXISTS idx_analytics_user_id ON analytics(user_id);
CREATE INDEX IF NOT EXISTS idx_analytics_data ON analytics USING GIN(data);

-- –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø–∏—Å—å –∞–Ω–æ–Ω–∏–º–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
ALTER TABLE analytics ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anon insert" ON analytics FOR INSERT TO anon WITH CHECK (true);
CREATE POLICY "Auth read" ON analytics FOR SELECT TO authenticated USING (true);
```

---

## 2Ô∏è‚É£ –®–ê–ì 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ GitHub

–ù—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –Ω–∞ –Ω–æ–≤—ã–π (v3).

1.  –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: `https://github.com/dmitriykontekstpro-lang/collector.min.js`
2.  –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª **`collector.min.js`**.
3.  –ù–∞–∂–º–∏—Ç–µ ‚úèÔ∏è (Edit).
4.  **–£–î–ê–õ–ò–¢–ï –≤–µ—Å—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥** –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –Ω–æ–≤—ã–π –∫–æ–¥ —Ü–µ–ª–∏–∫–æ–º:

```javascript
(function(){'use strict';window.TildaAnalytics={version:'3.0.0',config:null,supabase:null,userId:null,sessionId:null,context:{},_eventBuffer:[],async init(config){this.config={supabaseUrl:'',supabaseKey:'',tableName:'analytics',debug:false,batchInterval:5000,yandexMetrikaId:null,...config};if(typeof supabase==='undefined'){console.error('Supabase client not loaded');return;}this.supabase=supabase.createClient(this.config.supabaseUrl,this.config.supabaseKey);this._initIdentity();this._initContext();this._trackEvent('session_start');this._trackEvent('page_view');this._initListeners();this._initBatchSender();if(this.config.yandexMetrikaId)this._initYandexMetrika();},_initIdentity(){let uid=localStorage.getItem('ta_uid');if(!uid){uid=this._uuid();localStorage.setItem('ta_uid',uid);}this.userId=uid;let sid=sessionStorage.getItem('ta_sid');if(!sid){sid=this._uuid();sessionStorage.setItem('ta_sid',sid);}this.sessionId=sid;},_initContext(){this.context={ua:navigator.userAgent,screen:`${window.screen.width}x${window.screen.height}`,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,is_mobile:/Mobile|Android|iPhone/i.test(navigator.userAgent),referrer:document.referrer||null,...this._getUTM(),entry_url:window.location.href};},_getUTM(){const p=new URLSearchParams(window.location.search);return{utm_source:p.get('utm_source'),utm_medium:p.get('utm_medium'),utm_campaign:p.get('utm_campaign'),utm_content:p.get('utm_content'),utm_term:p.get('utm_term'),yclid:p.get('yclid'),gclid:p.get('gclid')};},_trackEvent(name,props={}){const event={event_name:name,user_id:this.userId,session_id:this.sessionId,page_url:window.location.href,created_at:new Date().toISOString(),data:{...this.context,...props,page_title:document.title}};this._eventBuffer.push(event);if(this.config.debug)console.log('[TildaAnalytics]',name);if(this._eventBuffer.length>=5||['form_submit','yandex_goal'].includes(name)){this._flush();}},async _flush(){if(!this._eventBuffer.length)return;const events=[...this._eventBuffer];this._eventBuffer=[];const{error}=await this.supabase.from(this.config.tableName).insert(events);if(error){console.error('Send error:',error);}else if(this.config.debug){console.log(`Sent ${events.length} events`);}},_initBatchSender(){setInterval(()=>this._flush(),this.config.batchInterval);window.addEventListener('beforeunload',()=>this._flush());},_initListeners(){document.addEventListener('click',(e)=>{const target=e.target.closest('a, button, .t-btn, [role="button"]');if(target){this._trackEvent('click',{text:target.innerText||'',href:target.getAttribute('href'),id:target.id,class:target.className});}},true);let scrollTimeout;window.addEventListener('scroll',()=>{clearTimeout(scrollTimeout);scrollTimeout=setTimeout(()=>{this._trackEvent('scroll',{depth_px:window.scrollY,depth_pct:Math.round((window.scrollY/(document.body.scrollHeight-window.innerHeight))*100)});},1000);});document.addEventListener('submit',(e)=>{const form=e.target;const formData=new FormData(form);const data={};formData.forEach((v,k)=>{if(k.includes('email')||k.includes('phone')||k.includes('name'))data[k]=v;});this._trackEvent('form_submit',{form_id:form.id,form_data:data});});},_initYandexMetrika(){const originalYm=window.ym;if(!originalYm)return;window.ym=(...args)=>{if(args[1]==='reachGoal'){this._trackEvent('yandex_goal',{goal_name:args[2],goal_params:args[3],ym_id:args[0]});}originalYm(...args);};},_uuid(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{const r=Math.random()*16|0,v=c=='x'?r:(r&0x3|0x8);return v.toString(16);});}}})();
```

5.  –ù–∞–∂–º–∏—Ç–µ **Commit changes**.

---

## 3Ô∏è‚É£ –®–ê–ì 3: –í—Å—Ç–∞–≤–∫–∞ –∫–æ–¥–∞ –≤ Tilda

–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É `raw.githubusercontent.com`, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å GitHub –ø–æ–¥—Ç—è–≥–∏–≤–∞–ª–∏—Å—å **–º–≥–Ω–æ–≤–µ–Ω–Ω–æ**, –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ CDN.

1.  –í Tilda –ø–µ—Ä–µ–π–¥–∏—Ç–µ: **Site Settings** ‚Üí **Advanced** ‚Üí **Code in <head>**.
2.  –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ (—Å –≤–∞—à–∏–º–∏ –∫–ª—é—á–∞–º–∏):

```html
<!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ Supabase –∏ Fingerprint -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3"></script>

<!-- –í–∞—à —Å–∫—Ä–∏–ø—Ç —Å GitHub (–ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞) -->
<script src="https://raw.githubusercontent.com/dmitriykontekstpro-lang/collector.min.js/main/collector.min.js"></script>

<!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞, –µ—Å–ª–∏ –æ–Ω –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤
    const init = () => {
        if (typeof TildaAnalytics !== 'undefined') {
            TildaAnalytics.init({
                // –í–∞—à–∏ –∫–ª—é—á–∏
                supabaseUrl: 'https://qqfyjrugrinmdijpsutj.supabase.co',
                supabaseKey: 'sb_publishable_KzDns19CaSpI-40YZgPPCg_hCDb-1Iz',
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                yandexMetrikaId: 51854510,
                debug: true // –ü–æ—Å—Ç–∞–≤—å—Ç–µ false –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏!
            });
            console.log('‚úÖ Tilda Analytics (v3 Single Table) initialized');
        } else {
            console.log('‚è≥ Waiting for script...');
            setTimeout(init, 500);
        }
    };
    init();
  });
</script>
```

3.  –ù–∞–∂–º–∏—Ç–µ **Save**.
4.  –ù–∞–∂–º–∏—Ç–µ **Publish**.

---

## ‚úÖ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å?

1.  –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Å–∞–π—Ç.
2.  –ù–∞–∂–º–∏—Ç–µ **F12** (Console).
3.  –í—ã –¥–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å: `Tilda Analytics initialized` –∏ –∑–∞—Ç–µ–º `[TildaAnalytics] session_start`.
4.  –í Supabase –≤ —Ç–∞–±–ª–∏—Ü–µ `analytics` –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏.

**–ì–æ—Ç–æ–≤–æ!** –¢–µ–ø–µ—Ä—å —É –≤–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ–≤–∞—è –±—ã—Å—Ç—Ä–∞—è –≤–µ—Ä—Å–∏—è 3.0.
