(function () {
    'use strict';
    window.TildaAnalytics = {
        version: '2.0.1',
        config: null,
        supabase: null,
        userId: null,
        sessionId: null,
        fingerprint: null,
        sessionStartTime: null,
        lastActivityTime: null,
        pageStartTime: null,
        metrics: {
            session_duration_sec: 0,
            time_to_first_click: null,
            active_time_on_page: 0,
            time_on_pricing_block: 0,
            time_on_reviews_block: 0,
            average_time_per_screen: 0,
            max_scroll_depth_percent: 0,
            scroll_velocity_avg: 0,
            scroll_up_count: 0,
            scroll_pauses_count: 0,
            fast_scroll_events: 0,
            reached_footer: false,
            total_clicks: 0,
            rage_clicks_count: 0,
            dead_clicks_count: 0,
            mouse_distance_px: 0,
            hover_cta_count: 0,
            hover_image_duration: 0,
            text_selection_count: 0,
            copy_to_clipboard_events: 0,
            exit_intent_signals: 0,
            form_focus_count: 0,
            form_typing_duration: 0,
            field_corrections_count: 0,
            form_abandonment_rate: false,
            paste_in_form_count: 0,
            is_mobile: false,
            screen_orientation: 'landscape',
            browser_language_match: true,
            connection_type: 'unknown',
            battery_level: null,
            window_resize_count: 0,
            visit_hour_local: 0,
            is_weekend: false,
            referrer_type: 'direct',
            visits_count: 1,
            days_since_last_visit: null,
            utm_depth: 0,
            content_consumption_rate: 0,
            interaction_intensity: 0,
            focus_switches: 0,
            zoom_events: 0,
            gallery_arrows_click: 0,
            video_play_rate: 0,
            accordion_expand_count: 0,
            popup_close_time: null,
            social_links_click: false,
            logo_click_count: 0,
            map_interaction: false,
            error_encounter_count: 0
        },
        _scrollHistory: [],
        _mousePositions: [],
        _clickTimestamps: [],
        _formStartTime: null,
        _backspaceCount: 0,
        _activeTimeTracker: null,
        _blockObservers: new Map(),
        _eventBuffer: [],
        _isPageVisible: true,

        async init(config) {
            try {
                this.config = {
                    supabaseUrl: '',
                    supabaseKey: '',
                    debug: false,
                    batchInterval: 5000,
                    maxBatchSize: 10,
                    sessionTimeout: 1800000,
                    trackMouseMovement: false,
                    scrollDebounce: 200,
                    mouseDebounce: 500,
                    scrollThresholds: [25, 50, 75, 90, 100],
                    collectIP: false,
                    useFingerprintJS: true,
                    requireConsent: false,
                    customEvents: {},
                    excludeSelectors: [],
                    yandexMetrikaId: null,
                    ...config
                };

                if (this.config.requireConsent && !this._checkConsent()) {
                    this._log('Analytics disabled: no consent');
                    return;
                }

                if (typeof supabase === 'undefined') {
                    throw new Error('Supabase JS client not loaded. Include CDN script first.');
                }

                this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey);

                await this._initIdentity();
                this._initSession();
                this._collectDeviceMetrics();
                this._collectContextMetrics();
                this._initEventListeners();
                this._startActiveTimeTracker();
                this._startBatchSender();
                this._trackPageView();

                if (this.config.yandexMetrikaId) {
                    this._initYandexMetrika();
                }

                this._log('âœ… Tilda Analytics initialized', { userId: this.userId, sessionId: this.sessionId, fingerprint: this.fingerprint });

                if (this.config.callbacks?.onInit) {
                    this.config.callbacks.onInit(this.userId, this.sessionId);
                }

            } catch (error) {
                this._handleError('Initialization failed', error);
            }
        },

        async _initIdentity() {
            if (this.config.useFingerprintJS && window.FingerprintJS) {
                try {
                    const fp = await FingerprintJS.load();
                    const result = await fp.get();
                    this.fingerprint = result.visitorId;
                    this.userId = result.visitorId;
                    this._log('Identity via FingerprintJS:', this.userId);
                } catch (error) {
                    this._log('FingerprintJS failed, using fallback');
                }
            }

            if (!this.userId) {
                this.userId = localStorage.getItem('tilda_analytics_user_id');
                if (!this.userId) {
                    this.userId = this._generateUUID();
                    localStorage.setItem('tilda_analytics_user_id', this.userId);
                }
                this.fingerprint = this.userId;
            }

            await this._upsertUser();
        },

        async _upsertUser() {
            try {
                const { data, error } = await this.supabase
                    .from('users')
                    .upsert({
                        user_id: this.userId,
                        device_fingerprint: this.fingerprint,
                        last_seen_at: new Date().toISOString()
                    }, {
                        onConflict: 'device_fingerprint'
                    });

                if (error) throw error;
            } catch (error) {
                this._handleError('Failed to upsert user', error);
            }
        },

        _initSession() {
            const now = Date.now();
            let storedSession = sessionStorage.getItem('tilda_analytics_session');

            if (storedSession) {
                try {
                    const session = JSON.parse(storedSession);
                    const timeSinceLastActivity = now - session.lastActivity;

                    if (timeSinceLastActivity < this.config.sessionTimeout) {
                        this.sessionId = session.id;
                        this.sessionStartTime = session.startTime;
                        this._log('Continuing session:', this.sessionId);
                    }
                } catch (error) {
                    this._log('Failed to parse stored session');
                }
            }

            if (!this.sessionId) {
                this.sessionId = this._generateUUID();
                this.sessionStartTime = now;
                this._createSession();
                this._log('New session created:', this.sessionId);
            }

            sessionStorage.setItem('tilda_analytics_session', JSON.stringify({
                id: this.sessionId,
                startTime: this.sessionStartTime,
                lastActivity: now
            }));

            this.pageStartTime = now;
            this.lastActivityTime = now;

            const visitsCount = parseInt(localStorage.getItem('tilda_analytics_visits') || '0') + 1;
            localStorage.setItem('tilda_analytics_visits', visitsCount.toString());
            this.metrics.visits_count = visitsCount;

            const lastVisit = localStorage.getItem('tilda_analytics_last_visit');
            if (lastVisit) {
                const daysSince = Math.floor((now - parseInt(lastVisit)) / (1000 * 60 * 60 * 24));
                this.metrics.days_since_last_visit = daysSince;
            }
            localStorage.setItem('tilda_analytics_last_visit', now.toString());
        },

        async _createSession() {
            try {
                const utmParams = this._parseUTM();
                const deviceInfo = this._getDeviceInfo();

                const { data, error } = await this.supabase
                    .from('sessions')
                    .insert({
                        session_id: this.sessionId,
                        user_id: this.userId,
                        utm_source: utmParams.utm_source,
                        utm_medium: utmParams.utm_medium,
                        utm_campaign: utmParams.utm_campaign,
                        utm_content: utmParams.utm_content,
                        utm_term: utmParams.utm_term,
                        yclid: utmParams.yclid,
                        gclid: utmParams.gclid,
                        fbclid: utmParams.fbclid,
                        referrer: document.referrer || null,
                        entry_url: window.location.href,
                        user_agent: navigator.userAgent,
                        device_type: deviceInfo.type,
                        os: deviceInfo.os,
                        browser: deviceInfo.browser,
                        screen_resolution: `${screen.width}x${screen.height}`,
                        viewport_size: `${window.innerWidth}x${window.innerHeight}`,
                        language: navigator.language,
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    });

                if (error) throw error;
            } catch (error) {
                this._handleError('Failed to create session', error);
            }
        },

        _parseUTM() {
            const params = new URLSearchParams(window.location.search);
            const utm = {
                utm_source: params.get('utm_source'),
                utm_medium: params.get('utm_medium'),
                utm_campaign: params.get('utm_campaign'),
                utm_content: params.get('utm_content'),
                utm_term: params.get('utm_term'),
                yclid: params.get('yclid'),
                gclid: params.get('gclid'),
                fbclid: params.get('fbclid')
            };

            let depth = 0;
            Object.values(utm).forEach(v => { if (v) depth++; });
            this.metrics.utm_depth = depth;

            if (utm.utm_source || utm.gclid || utm.yclid) {
                this.metrics.referrer_type = 'paid';
            } else if (document.referrer) {
                const ref = new URL(document.referrer);
                if (ref.hostname.includes('google') || ref.hostname.includes('yandex')) {
                    this.metrics.referrer_type = 'search';
                } else if (ref.hostname.includes('facebook') || ref.hostname.includes('instagram') || ref.hostname.includes('vk.com')) {
                    this.metrics.referrer_type = 'social';
                } else {
                    this.metrics.referrer_type = 'referral';
                }
            } else {
                this.metrics.referrer_type = 'direct';
            }

            return utm;
        },

        _collectDeviceMetrics() {
            this.metrics.is_mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

            if (window.screen.orientation) {
                this.metrics.screen_orientation = window.screen.orientation.type.includes('portrait') ? 'portrait' : 'landscape';
            } else {
                this.metrics.screen_orientation = window.innerHeight > window.innerWidth ? 'portrait' : 'landscape';
            }

            const pageLang = document.documentElement.lang || 'ru';
            const browserLang = navigator.language.split('-')[0];
            this.metrics.browser_language_match = pageLang.toLowerCase() === browserLang.toLowerCase();

            if (navigator.connection) {
                this.metrics.connection_type = navigator.connection.effectiveType || 'unknown';
            }

            if (navigator.getBattery) {
                navigator.getBattery().then(battery => {
                    this.metrics.battery_level = battery.level;
                });
            }
        },

        _getDeviceInfo() {
            const ua = navigator.userAgent;
            let type = 'desktop';
            let os = 'Unknown';
            let browser = 'Unknown';

            if (/tablet|ipad/i.test(ua)) {
                type = 'tablet';
            } else if (/mobile|android|iphone/i.test(ua)) {
                type = 'mobile';
            }

            if (/windows/i.test(ua)) os = 'Windows';
            else if (/mac/i.test(ua)) os = 'macOS';
            else if (/linux/i.test(ua)) os = 'Linux';
            else if (/android/i.test(ua)) os = 'Android';
            else if (/ios|iphone|ipad/i.test(ua)) os = 'iOS';

            if (/chrome/i.test(ua) && !/edg/i.test(ua)) browser = 'Chrome';
            else if (/safari/i.test(ua) && !/chrome/i.test(ua)) browser = 'Safari';
            else if (/firefox/i.test(ua)) browser = 'Firefox';
            else if (/edg/i.test(ua)) browser = 'Edge';

            return { type, os, browser };
        },

        _collectContextMetrics() {
            const now = new Date();
            this.metrics.visit_hour_local = now.getHours();
            this.metrics.is_weekend = now.getDay() === 0 || now.getDay() === 6;
        },

        _initEventListeners() {
            document.addEventListener('click', this._handleClick.bind(this), true);
            window.addEventListener('scroll', this._debounce(this._handleScroll.bind(this), this.config.scrollDebounce), { passive: true });

            if (this.config.trackMouseMovement) {
                document.addEventListener('mousemove', this._debounce(this._handleMouseMove.bind(this), this.config.mouseDebounce), { passive: true });
            }

            document.addEventListener('mouseover', this._handleMouseOver.bind(this), { passive: true });
            document.addEventListener('mouseout', this._handleMouseOut.bind(this), { passive: true });
            document.addEventListener('mouseout', this._handleExitIntent.bind(this), { passive: true });
            document.addEventListener('selectionchange', this._handleTextSelection.bind(this));
            document.addEventListener('copy', this._handleCopy.bind(this));

            this._initFormTracking();

            document.addEventListener('visibilitychange', this._handleVisibilityChange.bind(this));
            window.addEventListener('resize', this._handleResize.bind(this));
            window.addEventListener('blur', this._handleBlur.bind(this));
            window.addEventListener('focus', this._handleFocus.bind(this));
            window.addEventListener('beforeunload', this._handleBeforeUnload.bind(this));
            window.addEventListener('error', this._handleJSError.bind(this));

            if (this.metrics.is_mobile) {
                document.addEventListener('gesturestart', this._handleZoom.bind(this), { passive: true });
                document.addEventListener('touchstart', this._handleTouchStart.bind(this), { passive: true });
            }

            this._initBlockObservers();
        },

        _handleClick(event) {
            const now = Date.now();

            if (this.metrics.time_to_first_click === null) {
                this.metrics.time_to_first_click = (now - this.pageStartTime) / 1000;
            }

            this.metrics.total_clicks++;
            this.lastActivityTime = now;

            const target = event.target;
            const cssPath = this._getCSSPath(target);
            const text = this._getElementText(target);

            this._clickTimestamps.push(now);
            this._clickTimestamps = this._clickTimestamps.filter(t => now - t < 1000);
            if (this._clickTimestamps.length >= 3) {
                this.metrics.rage_clicks_count++;
                this._log('âš¡ Rage click detected');
            }

            if (!target.matches('a, button, input, select, textarea, [onclick], [role="button"]')) {
                this.metrics.dead_clicks_count++;
            }

            if (target.closest('.t-logo, .t-name, [data-elem-id="logo"]')) {
                this.metrics.logo_click_count++;
            }

            if (target.closest('a[href*="vk.com"], a[href*="facebook"], a[href*="instagram"], a[href*="telegram"]')) {
                this.metrics.social_links_click = true;
            }

            if (target.closest('.t-slds__arrow_container, .t-carousel__arrow')) {
                this.metrics.gallery_arrows_click++;
            }

            if (target.closest('[id*="map"], .t-map, iframe[src*="maps"]')) {
                this.metrics.map_interaction = true;
            }

            if (target.closest('.t-accordion, .t-faq, [data-elem-type="accordion"]')) {
                this.metrics.accordion_expand_count++;
            }

            if (target.closest('.t-popup__close, .popup__close, [data-popup-close]')) {
                if (this._popupOpenTime) {
                    this.metrics.popup_close_time = (now - this._popupOpenTime) / 1000;
                }
            }

            this._trackEvent('click', {
                target_element: cssPath,
                target_text: text,
                target_href: target.href || null,
                payload: {
                    click: {
                        x: event.clientX,
                        y: event.clientY,
                        pageX: event.pageX,
                        pageY: event.pageY,
                        button: event.button,
                        ctrlKey: event.ctrlKey,
                        shiftKey: event.shiftKey,
                        altKey: event.altKey
                    },
                    timing: {
                        timeOnPage: (now - this.pageStartTime) / 1000,
                        timeSinceLastEvent: this.lastActivityTime ? (now - this.lastActivityTime) / 1000 : 0
                    }
                }
            });
        },

        _handleScroll() {
            const now = Date.now();
            const scrollY = window.scrollY;
            const docHeight = document.documentElement.scrollHeight;
            const viewportHeight = window.innerHeight;
            const scrollableHeight = docHeight - viewportHeight;
            const scrollPercent = Math.round((scrollY / scrollableHeight) * 100);

            if (scrollPercent > this.metrics.max_scroll_depth_percent) {
                this.metrics.max_scroll_depth_percent = scrollPercent;
            }

            if (scrollPercent >= 95) {
                this.metrics.reached_footer = true;
            }

            if (this._scrollHistory.length > 0) {
                const lastScroll = this._scrollHistory[this._scrollHistory.length - 1];
                const timeDiff = (now - lastScroll.time) / 1000;
                const distDiff = Math.abs(scrollY - lastScroll.y);
                const velocity = distDiff / timeDiff;

                this.metrics.scroll_velocity_avg = (this.metrics.scroll_velocity_avg + velocity) / 2;

                if (velocity > 1000) {
                    this.metrics.fast_scroll_events++;
                }

                if (scrollY < lastScroll.y) {
                    this.metrics.scroll_up_count++;
                }

                if (velocity < 50) {
                    this.metrics.scroll_pauses_count++;
                }
            }

            this._scrollHistory.push({ y: scrollY, time: now });
            if (this._scrollHistory.length > 5) {
                this._scrollHistory.shift();
            }

            this.config.scrollThresholds.forEach(threshold => {
                if (scrollPercent >= threshold && !this._scrollMilestones?.[threshold]) {
                    if (!this._scrollMilestones) this._scrollMilestones = {};
                    this._scrollMilestones[threshold] = true;

                    this._trackEvent('scroll', {
                        page_url: window.location.href,
                        payload: {
                            scroll: {
                                scrollY,
                                scrollPercent,
                                scrollDepth: `${threshold}%`,
                                docHeight,
                                viewportHeight
                            }
                        }
                    });
                }
            });

            this.lastActivityTime = now;
        },

        _handleMouseMove(event) {
            const now = Date.now();

            if (this._mousePositions.length > 0) {
                const lastPos = this._mousePositions[this._mousePositions.length - 1];
                const dist = Math.sqrt(
                    Math.pow(event.clientX - lastPos.x, 2) +
                    Math.pow(event.clientY - lastPos.y, 2)
                );
                this.metrics.mouse_distance_px += dist;
            }

            this._mousePositions.push({ x: event.clientX, y: event.clientY, time: now });
            if (this._mousePositions.length > 10) {
                this._mousePositions.shift();
            }
        },

        _handleMouseOver(event) {
            const target = event.target;

            if (target.matches('a.t-btn, button.t-btn, .t-submit, [data-elem-type="button"]')) {
                this.metrics.hover_cta_count++;
                this._hoverStartTime = Date.now();
            }

            if (target.matches('img, .t-bgimg, .t-img, picture')) {
                this._imageHoverStart = Date.now();
            }
        },

        _handleMouseOut(event) {
            const target = event.target;

            if (this._imageHoverStart && target.matches('img, .t-bgimg, .t-img, picture')) {
                this.metrics.hover_image_duration += (Date.now() - this._imageHoverStart) / 1000;
                this._imageHoverStart = null;
            }
        },

        _handleExitIntent(event) {
            if (event.clientY <= 0 && event.relatedTarget == null) {
                this.metrics.exit_intent_signals++;
            }
        },

        _handleTextSelection() {
            const selection = window.getSelection();
            if (selection && selection.toString().length > 0) {
                this.metrics.text_selection_count++;
            }
        },

        _handleCopy() {
            this.metrics.copy_to_clipboard_events++;
            this._log('ðŸ“‹ Copy to clipboard');
        },

        _initFormTracking() {
            const forms = document.querySelectorAll('form, .t-form, [data-elem-type="form"]');

            forms.forEach(form => {
                const inputs = form.querySelectorAll('input, textarea, select');

                inputs.forEach(input => {
                    input.addEventListener('focus', () => {
                        this.metrics.form_focus_count++;
                        if (!this._formStartTime) {
                            this._formStartTime = Date.now();
                        }
                        this._log('ðŸ“ Form field focused');
                    });

                    input.addEventListener('input', () => {
                        if (this._formStartTime) {
                            this.metrics.form_typing_duration = (Date.now() - this._formStartTime) / 1000;
                        }
                    });

                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace') {
                            this.metrics.field_corrections_count++;
                        }
                    });

                    input.addEventListener('paste', () => {
                        this.metrics.paste_in_form_count++;
                    });
                });

                form.addEventListener('submit', async (event) => {
                    this._handleFormSubmit(event, form);
                });
            });

            if (window.jQuery) {
                jQuery(document).on('tildaform:aftersuccess', (e, formData) => {
                    this._handleTildaFormSuccess(formData);
                });
            }
        },

        async _handleFormSubmit(event, form) {
            this._log('âœ… Form submitted');

            const formData = new FormData(form);
            const fields = {};

            for (let [key, value] of formData.entries()) {
                if (key.toLowerCase().includes('email') ||
                    key.toLowerCase().includes('phone') ||
                    key.toLowerCase().includes('name')) {
                    fields[key] = value;
                }
            }

            if (fields.email || fields.phone) {
                await this._updateUserContact({
                    email: fields.email || null,
                    phone: fields.phone || null,
                    name: fields.name || null
                });
            }

            this._trackEvent('form_submit', {
                page_url: window.location.href,
                payload: {
                    form: {
                        formId: form.id || form.className,
                        formName: form.getAttribute('data-form-name') || 'unknown',
                        fieldCount: form.querySelectorAll('input, textarea, select').length,
                        fields: fields,
                        formValid: form.checkValidity(),
                        attemptNumber: 1
                    },
                    timing: {
                        timeOnPage: (Date.now() - this.pageStartTime) / 1000,
                        formFillTime: this._formStartTime ? (Date.now() - this._formStartTime) / 1000 : 0
                    }
                }
            });

            this.metrics.form_abandonment_rate = false;
        },

        async _handleTildaFormSuccess(formData) {
            this._log('âœ… Tilda form success:', formData);

            const contactData = {};

            if (formData.email) contactData.email = formData.email;
            if (formData.phone) contactData.phone = formData.phone;
            if (formData.name) contactData.name = formData.name;

            if (Object.keys(contactData).length > 0) {
                await this._updateUserContact(contactData);
            }
        },

        async _updateUserContact(contactData) {
            try {
                const { error } = await this.supabase
                    .from('users')
                    .update({
                        contact_data: contactData,
                        updated_at: new Date().toISOString()
                    })
                    .eq('user_id', this.userId);

                if (error) throw error;
                this._log('ðŸ“ž Contact data updated:', contactData);
            } catch (error) {
                this._handleError('Failed to update contact data', error);
            }
        },

        _initBlockObservers() {
            const pricingBlocks = document.querySelectorAll('.t-price, .t-store__price, [data-elem-type="price"]');
            this._observeBlocks(pricingBlocks, 'time_on_pricing_block');

            const reviewsBlocks = document.querySelectorAll('.t-reviews, .t-testimonials, [data-elem-type="reviews"]');
            this._observeBlocks(reviewsBlocks, 'time_on_reviews_block');
        },

        _observeBlocks(elements, metricKey) {
            if (!window.IntersectionObserver) return;

            elements.forEach(element => {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const startTime = Date.now();
                            this._blockObservers.set(element, { startTime, metricKey });
                        } else {
                            const data = this._blockObservers.get(element);
                            if (data) {
                                const duration = (Date.now() - data.startTime) / 1000;
                                this.metrics[data.metricKey] += duration;
                                this._blockObservers.delete(element);
                            }
                        }
                    });
                }, { threshold: 0.5 });

                observer.observe(element);
            });
        },

        _startActiveTimeTracker() {
            this._activeTimeInterval = setInterval(() => {
                if (this._isPageVisible && document.hasFocus()) {
                    this.metrics.active_time_on_page++;
                }
            }, 1000);
        },

        _handleVisibilityChange() {
            this._isPageVisible = !document.hidden;
        },

        _handleBlur() {
            this.metrics.focus_switches++;
        },

        _handleFocus() {
        },

        _handleResize() {
            this.metrics.window_resize_count++;
        },

        _handleZoom() {
            this.metrics.zoom_events++;
        },

        _handleTouchStart(event) {
            if (event.touches.length > 1) {
                this.metrics.zoom_events++;
            }
        },

        _handleJSError(event) {
            this.metrics.error_encounter_count++;
            this._log('âŒ JavaScript error:', event.message);
        },

        _initYandexMetrika() {
            this._log('Initializing Yandex.Metrika integration...');

            const installProxy = () => {
                if (!window.ym) {
                    this._log('âš ï¸ window.ym not found');
                    return false;
                }

                const originalYM = window.ym;

                window.ym = (...args) => {
                    const counterId = args[0];
                    const method = args[1];
                    const goalName = args[2];
                    const params = args[3];

                    if (method === 'reachGoal') {
                        this._trackYandexGoal(goalName, params);
                    }

                    return originalYM.apply(window, args);
                };

                Object.keys(originalYM).forEach(key => {
                    window.ym[key] = originalYM[key];
                });

                this._log('âœ… Yandex.Metrika proxy installed');
                return true;
            };

            if (window.ym) {
                installProxy();
                return;
            }

            let attempts = 0;
            const maxAttempts = 50;

            const checkInterval = setInterval(() => {
                attempts++;

                if (window.ym) {
                    clearInterval(checkInterval);
                    installProxy();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    this._log('âš ï¸ Yandex.Metrika not loaded after 5 seconds');
                    this._installYMLazyProxy();
                }
            }, 100);
        },

        _installYMLazyProxy() {
            const self = this;
            let proxyInstalled = false;

            Object.defineProperty(window, 'ym', {
                get() {
                    return this._ymFunction;
                },
                set(value) {
                    this._ymFunction = value;

                    if (!proxyInstalled && typeof value === 'function') {
                        proxyInstalled = true;
                        const originalYM = value;

                        this._ymFunction = function (...args) {
                            const method = args[1];
                            const goalName = args[2];
                            const params = args[3];

                            if (method === 'reachGoal') {
                                self._trackYandexGoal(goalName, params);
                            }

                            return originalYM.apply(window, args);
                        };

                        self._log('âœ… Yandex.Metrika lazy proxy installed');
                    }
                },
                configurable: true
            });
        },

        _trackYandexGoal(goalName, params = null) {
            this._log('ðŸŽ¯ Yandex goal reached:', goalName, params);

            this._trackEvent('yandex_goal', {
                page_url: window.location.href,
                target_text: goalName,
                payload: {
                    custom: {
                        goalName: goalName,
                        goalType: 'yandex_metrika',
                        goalParams: params || {},
                        ymCounterId: this.config.yandexMetrikaId || null,
                        timestamp: Date.now()
                    },
                    timing: {
                        timeOnPage: (Date.now() - this.pageStartTime) / 1000
                    }
                }
            });
        },

        _trackPageView() {
            this._trackEvent('page_view', {
                page_url: window.location.href,
                payload: {
                    performance: this._getPerformanceMetrics(),
                    viewport: {
                        width: window.innerWidth,
                        height: window.innerHeight
                    },
                    document: {
                        title: document.title,
                        docHeight: document.documentElement.scrollHeight
                    }
                }
            });
        },

        _getPerformanceMetrics() {
            if (!window.performance || !window.performance.timing) return {};

            const timing = window.performance.timing;
            const navigation = window.performance.navigation;

            return {
                loadTime: timing.loadEventEnd - timing.navigationStart,
                domReady: timing.domContentLoadedEventEnd - timing.navigationStart,
                firstPaint: timing.responseStart - timing.navigationStart,
                memoryUsed: performance.memory?.usedJSHeapSize || null,
                hardwareConcurrency: navigator.hardwareConcurrency || null,
                connectionType: navigator.connection?.effectiveType || 'unknown',
                downlink: navigator.connection?.downlink || null
            };
        },

        _trackEvent(eventType, data = {}) {
            const event = {
                session_id: this.sessionId,
                event_type: eventType,
                page_url: data.page_url || window.location.href,
                target_element: data.target_element || null,
                target_text: data.target_text || null,
                target_href: data.target_href || null,
                payload: data.payload || {},
                created_at: new Date().toISOString()
            };

            this._eventBuffer.push(event);

            const criticalEvents = ['form_submit', 'yandex_goal', 'custom_goal'];
            if (criticalEvents.includes(eventType) || this._eventBuffer.length >= this.config.maxBatchSize) {
                this._flushEvents();
            }
        },

        _startBatchSender() {
            this._batchInterval = setInterval(() => {
                this._flushEvents();
            }, this.config.batchInterval);
        },

        async _flushEvents() {
            if (this._eventBuffer.length === 0) return;

            const events = [...this._eventBuffer];
            this._eventBuffer = [];

            try {
                const { error } = await this.supabase
                    .from('events')
                    .insert(events);

                if (error) throw error;

                this._log(`ðŸ“¤ Sent ${events.length} events`);

                if (this.config.callbacks?.onBatchSent) {
                    this.config.callbacks.onBatchSent(events.length);
                }
            } catch (error) {
                this._handleError('Failed to send events', error);
                this._eventBuffer.unshift(...events);
            }
        },

        _handleBeforeUnload() {
            this._calculateDerivedMetrics();

            if (this._formStartTime && this.metrics.form_focus_count > 0) {
                const submittedForms = document.querySelectorAll('form.submitted, .t-form__success');
                if (submittedForms.length === 0) {
                    this.metrics.form_abandonment_rate = true;
                }
            }

            this.metrics.session_duration_sec = Math.round((Date.now() - this.sessionStartTime) / 1000);

            const finalMetrics = {
                session_id: this.sessionId,
                event_type: 'session_end',
                page_url: window.location.href,
                payload: {
                    metrics: this.metrics,
                    timing: {
                        sessionDuration: this.metrics.session_duration_sec,
                        activeTime: this.metrics.active_time_on_page
                    }
                },
                created_at: new Date().toISOString()
            };

            if (navigator.sendBeacon) {
                const blob = new Blob([JSON.stringify([finalMetrics])], { type: 'application/json' });
                const url = `${this.config.supabaseUrl}/rest/v1/events`;

                navigator.sendBeacon(url, blob);
            }

            this._updateSessionEndTime();

            this._log('ðŸ‘‹ Session ending, metrics saved');
        },

        async _updateSessionEndTime() {
            try {
                await this.supabase
                    .from('sessions')
                    .update({
                        session_duration: this.metrics.session_duration_sec,
                        pages_viewed: 1,
                        ended_at: new Date().toISOString()
                    })
                    .eq('session_id', this.sessionId);
            } catch (error) {
            }
        },

        _calculateDerivedMetrics() {
            const docHeight = document.documentElement.scrollHeight;
            const timeOnPage = (Date.now() - this.pageStartTime) / 1000;
            this.metrics.content_consumption_rate = timeOnPage > 0 ? docHeight / timeOnPage : 0;

            this.metrics.interaction_intensity = timeOnPage > 0 ?
                (this.metrics.total_clicks + this.metrics.scroll_pauses_count) / timeOnPage : 0;

            const screenCount = Math.ceil(this.metrics.max_scroll_depth_percent / 100 * (docHeight / window.innerHeight));
            this.metrics.average_time_per_screen = screenCount > 0 ? timeOnPage / screenCount : 0;
        },

        track(eventType, data = {}) {
            this._trackEvent(eventType, {
                page_url: window.location.href,
                payload: {
                    custom: data
                }
            });
        },

        goal(goalName, value = null) {
            this._trackEvent('custom_goal', {
                page_url: window.location.href,
                payload: {
                    custom: {
                        goalName,
                        goalValue: value,
                        goalCategory: 'custom'
                    }
                }
            });
        },

        getMetrics() {
            this._calculateDerivedMetrics();
            return { ...this.metrics };
        },

        _generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        },

        _getCSSPath(element) {
            if (!element) return '';

            const path = [];
            while (element && element.nodeType === Node.ELEMENT_NODE) {
                let selector = element.nodeName.toLowerCase();
                if (element.id) {
                    selector += `#${element.id}`;
                    path.unshift(selector);
                    break;
                } else {
                    let sibling = element;
                    let nth = 1;
                    while (sibling.previousElementSibling) {
                        sibling = sibling.previousElementSibling;
                        if (sibling.nodeName.toLowerCase() === selector) nth++;
                    }
                    if (nth !== 1) selector += `:nth-of-type(${nth})`;
                }
                path.unshift(selector);
                element = element.parentNode;
            }
            return path.join(' > ');
        },

        _getElementText(element) {
            let text = element.innerText || element.textContent || '';
            text = text.trim().substring(0, 100);
            return text || null;
        },

        _debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        },

        _checkConsent() {
            if (this.config.consentCheck && typeof this.config.consentCheck === 'function') {
                return this.config.consentCheck();
            }
            return true;
        },

        _log(...args) {
            if (this.config.debug) {
                console.log('[TildaAnalytics]', ...args);
            }
        },

        _handleError(message, error) {
            console.error(`[TildaAnalytics] ${message}:`, error);

            if (this.config.callbacks?.onError) {
                this.config.callbacks.onError(error);
            }
        }
    };

    if (window.TildaAnalyticsConfig) {
        window.TildaAnalytics.init(window.TildaAnalyticsConfig);
    }

})();
