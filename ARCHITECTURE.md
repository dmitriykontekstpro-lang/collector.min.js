# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹: Tilda Analytics

## ğŸ¯ ĞĞ±Ñ‰Ğ°Ñ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ° Ğ½Ğ° **event-driven Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğµ** Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğ¹ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¾Ğ¹ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ¸ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¹ Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸ĞµĞ¹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Tilda Website                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚            collector.js (Vanilla JavaScript)           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚  â”‚ Identity â”‚  â”‚   UTM    â”‚  â”‚  Device  â”‚            â”‚ â”‚
â”‚  â”‚  â”‚ Manager  â”‚  â”‚  Parser  â”‚  â”‚ Detector â”‚            â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚ â”‚
â”‚  â”‚  â”‚  Click   â”‚  â”‚  Scroll  â”‚  â”‚   Form   â”‚            â”‚ â”‚
â”‚  â”‚  â”‚ Tracker  â”‚  â”‚ Tracker  â”‚  â”‚Interceptorâ”‚           â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚ â”‚
â”‚  â”‚              â”‚  Event Buffer   â”‚                       â”‚ â”‚
â”‚  â”‚              â”‚  (Batch Queue)  â”‚                       â”‚ â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                          â”‚                                   â”‚
â”‚                          â–¼                                   â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚              â”‚  Supabase JS Client â”‚                        â”‚
â”‚              â”‚   (anon-key only)   â”‚                        â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ HTTPS (REST API)
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Supabase Backend                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  Row Level Security                     â”‚ â”‚
â”‚  â”‚          anon: INSERT only | auth: FULL                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                PostgreSQL Database                      â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
â”‚  â”‚  â”‚  users   â”‚  â”‚ sessions â”‚  â”‚  events (partitioned)â”‚ â”‚ â”‚
â”‚  â”‚  â”‚  (Core)  â”‚  â”‚ (Sessions)â”‚  â”‚  (Time-series data) â”‚ â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  Indexes: B-Tree, GIN (JSONB), Composite               â”‚ â”‚
â”‚  â”‚  Triggers: Auto-update timestamps, session counters    â”‚ â”‚
â”‚  â”‚  Partitioning: Monthly partitions on events table      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚ SQL Queries
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Analytics & ML Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Retool     â”‚  â”‚  JetAdmin    â”‚  â”‚     MindsDB      â”‚  â”‚
â”‚  â”‚ (Dashboards) â”‚  â”‚  (Admin UI)  â”‚  â”‚ (ML Predictions) â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ½Ñ‹Ğµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ

### 1. **Client-Side Data Collection**

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ½Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ĞºÑĞ¸?**
- Tilda - ĞºĞ¾Ğ½ÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¾Ñ€ Ğ±ĞµĞ· Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº ÑĞµÑ€Ğ²ĞµÑ€Ğ½Ğ¾Ğ¼Ñƒ ĞºĞ¾Ğ´Ñƒ
- ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ middleware
- ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ ĞºĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ¾Ğ¹ JavaScript Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°**:
- âœ… ĞŸÑ€Ğ¾ÑÑ‚Ğ°Ñ Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ (Ğ¾Ğ´Ğ¸Ğ½ `<script>` Ñ‚ĞµĞ³)
- âœ… Ğ ĞµĞ°Ğ»Ñ‚Ğ°Ğ¹Ğ¼ ÑĞ±Ğ¾Ñ€ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
- âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ½Ñ‹Ğ¼ API (Performance, Visibility)
- âœ… ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€

**ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸**:
- âŒ Ğ£ÑĞ·Ğ²Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğº Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°Ğ¼ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹
- âŒ ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ³Ğ¾ API ĞºĞ»ÑÑ‡Ğ°
- âŒ Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ğ¾Ñ‚ JavaScript Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ

**ĞœĞ¸Ñ‚Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ**:
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ RLS Ğ´Ğ»Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ² anon-ĞºĞ»ÑÑ‡Ğ°
- Fallback Ğ½Ğ° server-side tracking Ñ‡ĞµÑ€ĞµĞ· webhook (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

---

### 2. **Identity Resolution**

#### **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞšĞ°Ğº Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸Ñ†Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ±ĞµĞ· Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸?

#### **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ¢Ñ€ĞµÑ…ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ°Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸

```javascript
// Level 1: FingerprintJS (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚)
const fingerprint = await FingerprintJS.load();
const result = await fingerprint.get();
const visitorId = result.visitorId; // Ğ¡Ñ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ ID

// Level 2: localStorage UUID (fallback)
let userId = localStorage.getItem('analytics_user_id');
if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem('analytics_user_id', userId);
}

// Level 3: sessionStorage (one-time visitor)
let sessionId = sessionStorage.getItem('analytics_session_id');
if (!sessionId || isSessionExpired()) {
  sessionId = crypto.randomUUID();
  sessionStorage.setItem('analytics_session_id', sessionId);
}
```

**ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑĞµÑÑĞ¸Ğ¸**:
1. ĞŸÑ€Ğ¾ÑˆĞ»Ğ¾ > 30 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½ĞµĞ¹ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚Ğ¸
2. Ğ¡Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ñ‚Ñ€Ğ°Ñ„Ğ¸ĞºĞ° (referrer)
3. Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ UTM Ğ¼ĞµÑ‚ĞºĞ¸
4. ĞĞ¾Ğ²Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾/Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ° (sessionStorage ÑĞ±Ñ€Ğ¾ÑˆĞµĞ½)

---

### 3. **Event Batching Strategy**

#### **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: ĞšĞ°Ğº Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ·ĞºĞ¸ ÑĞµÑ‚Ğ¸ Ğ¸ Ğ‘Ğ”?

#### **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: Ğ˜Ğ½Ñ‚ĞµĞ»Ğ»ĞµĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ Ğ±Ğ°Ñ‚Ñ‡Ğ¸Ğ½Ğ³-ÑĞ¸ÑÑ‚ĞµĞ¼Ğ°

```javascript
class EventBatcher {
  constructor() {
    this.buffer = [];
    this.maxBufferSize = 10;    // ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ Ğ² Ğ±ÑƒÑ„ĞµÑ€Ğµ
    this.flushInterval = 5000;  // ĞĞ²Ñ‚Ğ¾Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 ÑĞµĞº
    this.criticalEvents = ['form_submit', 'purchase', 'signup'];
    
    setInterval(() => this.flush(), this.flushInterval);
    window.addEventListener('beforeunload', () => this.flush(true));
  }
  
  push(event) {
    this.buffer.push(event);
    
    // ĞĞµĞ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    if (this.criticalEvents.includes(event.event_type)) {
      this.flush(true);
      return;
    }
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ Ğ±ÑƒÑ„ĞµÑ€Ğ°
    if (this.buffer.length >= this.maxBufferSize) {
      this.flush();
    }
  }
  
  async flush(isBeacon = false) {
    if (this.buffer.length === 0) return;
    
    const events = [...this.buffer];
    this.buffer = [];
    
    if (isBeacon && navigator.sendBeacon) {
      // Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
      navigator.sendBeacon('/api/events', JSON.stringify(events));
    } else {
      // ĞĞ±Ñ‹Ñ‡Ğ½Ğ°Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ°
      await fetch('/api/events', {
        method: 'POST',
        body: JSON.stringify(events),
        keepalive: true
      });
    }
  }
}
```

---

### 4. **Database Partitioning**

#### **ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°**: Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `events` Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°ÑÑ‚Ğ¸ ÑĞºÑĞ¿Ğ¾Ğ½ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾

**ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·**:
- 1000 Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹/Ğ´ĞµĞ½ÑŒ Ã— 50 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ = 50,000 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹/Ğ´ĞµĞ½ÑŒ
- 1,500,000 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹/Ğ¼ĞµÑÑÑ†
- 18,000,000 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹/Ğ³Ğ¾Ğ´

#### **Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ**: ĞœĞµÑÑÑ‡Ğ½Ğ¾Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ + Ğ°Ğ²Ñ‚Ğ¾Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ

```sql
-- ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾ created_at (Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ½Ğ¾Ğµ)
CREATE TABLE events (
    id BIGSERIAL,
    session_id UUID NOT NULL,
    event_type TEXT NOT NULL,
    payload JSONB,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
) PARTITION BY RANGE (created_at);

-- ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ÑÑ‚ÑÑ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ‡ĞµÑ€ĞµĞ· Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ
CREATE TABLE events_2025_12 PARTITION OF events
    FOR VALUES FROM ('2025-12-01') TO ('2026-01-01');

CREATE TABLE events_2026_01 PARTITION OF events
    FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');

-- ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¹ Ñ‡ĞµÑ€ĞµĞ· pg_cron (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
SELECT cron.schedule('create_monthly_partition', '0 0 1 * *', $$
    -- SQL Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¹ Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¸
$$);
```

**Ğ¡Ñ‚Ñ€Ğ°Ñ‚ĞµĞ³Ğ¸Ñ Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸**:
- ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ€ÑˆĞµ 6 Ğ¼ĞµÑÑÑ†ĞµĞ² â†’ Ğ¿ĞµÑ€ĞµĞ¼ĞµÑ‰ĞµĞ½Ğ¸Ğµ Ğ² Ğ°Ñ€Ñ…Ğ¸Ğ²Ğ½ÑƒÑ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ
- ĞŸĞ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ€ÑˆĞµ 1 Ğ³Ğ¾Ğ´Ğ° â†’ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² S3/Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ
- Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· DROP TABLE (Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾Ğµ, Ğ±ĞµĞ· DELETE)

---

### 5. **JSONB Payload Structure**

#### **ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ JSONB, Ğ° Ğ½Ğµ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸?**

**ĞĞ½Ñ‚Ğ¸-Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ (EAV)**:
```sql
-- âŒ Entity-Attribute-Value (Ğ¿Ğ»Ğ¾Ñ…Ğ¾)
CREATE TABLE event_attributes (
    event_id BIGINT,
    attribute_name TEXT,
    attribute_value TEXT
);
-- Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: Ğ¼Ğ¸Ğ»Ğ»Ğ¸Ğ¾Ğ½Ñ‹ ÑÑ‚Ñ€Ğ¾Ğº, Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ JOIN'Ñ‹
```

**ĞĞ°ÑˆĞµ Ñ€ĞµÑˆĞµĞ½Ğ¸Ğµ (JSONB)**:
```sql
-- âœ… Structured JSONB (Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾)
CREATE TABLE events (
    ...
    payload JSONB
);

-- Ğ˜Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
CREATE INDEX idx_events_payload_gin ON events USING GIN (payload);

-- ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°
SELECT * FROM events 
WHERE payload @> '{"click": {"button": 0}}';
-- Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ GIN Ğ¸Ğ½Ğ´ĞµĞºÑÑƒ
```

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° JSONB**:
- âœ… Ğ“Ğ¸Ğ±ĞºĞ¾ÑÑ‚ÑŒ ÑÑ…ĞµĞ¼Ñ‹ (Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº Ğ±ĞµĞ· Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹)
- âœ… ĞÑ‚Ğ¾Ğ¼Ğ°Ñ€Ğ½Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (Ğ¾Ğ´Ğ½Ğ° ÑÑ‚Ñ€Ğ¾ĞºĞ° = Ğ¾Ğ´Ğ½Ğ¾ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ)
- âœ… GIN Ğ¸Ğ½Ğ´ĞµĞºÑÑ‹ Ğ´Ğ»Ñ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¸ÑĞºĞ°
- âœ… Ğ¡Ğ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ MindsDB Ğ´Ğ»Ñ ML

**ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸**:
- âŒ ĞĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ÑÑ‚ÑŒ NOT NULL Ğ½Ğ° Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑÑ…
- âŒ Ğ¡Ğ»Ğ¾Ğ¶Ğ½ĞµĞµ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ CHECK constraint Ğ½Ğ° JSON Schema)

**Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ‡ĞµÑ€ĞµĞ· CHECK constraint**:
```sql
ALTER TABLE events ADD CONSTRAINT payload_schema_check
CHECK (
    -- ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ğ¾Ğ»ĞµĞ¹ Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
    CASE 
        WHEN event_type = 'click' THEN 
            payload ? 'click' AND 
            (payload->'click'->>'x')::int IS NOT NULL
        WHEN event_type = 'scroll' THEN
            payload ? 'scroll' AND
            (payload->'scroll'->>'scrollPercent')::int BETWEEN 0 AND 100
        ELSE TRUE
    END
);
```

---

### 6. **Row Level Security (RLS)**

#### **ĞœĞ¾Ğ´ĞµĞ»ÑŒ ÑƒĞ³Ñ€Ğ¾Ğ·**:
1. **ĞŸÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ anon-ĞºĞ»ÑÑ‡ Ğ² JavaScript** â†’ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ
2. **ĞšĞ¾Ğ½ĞºÑƒÑ€ĞµĞ½Ñ‚Ñ‹ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ°Ñ‚ÑŒÑÑ** ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ²ÑÑ Ğ±Ğ°Ğ·Ñƒ
3. **Ğ˜Ğ½ÑŠĞµĞºÑ†Ğ¸Ñ Ğ¼ÑƒÑĞ¾Ñ€Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…** Ğ´Ğ»Ñ Ğ·Ğ°ÑĞ¾Ñ€ĞµĞ½Ğ¸Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸

#### **Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· RLS**:

```sql
-- Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ RLS Ğ½Ğ° Ğ²ÑĞµÑ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°Ñ…
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE sessions ENABLE ROW LEVEL SECURITY;
ALTER TABLE events ENABLE ROW LEVEL SECURITY;

-- ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° 1: anon Ñ€Ğ¾Ğ»ÑŒ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ÑÑ‚ÑŒ
CREATE POLICY "anon_insert_only_users" ON users
    FOR INSERT
    TO anon
    WITH CHECK (true);

CREATE POLICY "anon_no_select_users" ON users
    FOR SELECT
    TO anon
    USING (false); -- Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ

-- ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° 2: authenticated Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸Ğ¼ĞµÑÑ‚ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿
CREATE POLICY "auth_full_access_users" ON users
    FOR ALL
    TO authenticated
    USING (true)
    WITH CHECK (true);

-- ĞŸĞ¾Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° 3: service_role Ğ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ñ‚ RLS (Ğ´Ğ»Ñ admin Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸)
-- (service_role Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¸Ğ¼ĞµĞµÑ‚ BYPASSRLS)
```

**Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ°**:
- Rate limiting Ñ‡ĞµÑ€ĞµĞ· Supabase Edge Functions
- Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° payload (Ğ¼Ğ°ĞºÑ 10 KB)
- Honeypot Ğ¿Ğ¾Ğ»Ñ Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸ Ğ±Ğ¾Ñ‚Ğ¾Ğ²

---

### 7. **Performance Optimization**

#### **7.1. Frontend Optimization**

```javascript
// Debounce Ğ´Ğ»Ñ scroll/mousemove
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), wait);
  };
}

const trackScroll = debounce(() => {
  const scrollPercent = (window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100;
  collector.track('scroll', { scrollPercent });
}, 200); // 200ms Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°

window.addEventListener('scroll', trackScroll, { passive: true });
```

#### **7.2. Database Indexes**

```sql
-- Composite Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ Ñ‡Ğ°ÑÑ‚Ñ‹Ñ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
CREATE INDEX idx_sessions_user_created 
ON sessions(user_id, created_at DESC);

-- Partial Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ğ¾Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
CREATE INDEX idx_events_conversions 
ON events(session_id, created_at)
WHERE event_type IN ('form_submit', 'purchase');

-- Expression Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ´Ğ»Ñ JSONB
CREATE INDEX idx_events_scroll_depth
ON events ((payload->'scroll'->>'scrollPercent')::int)
WHERE event_type = 'scroll';
```

#### **7.3. Query Optimization**

```sql
-- âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾ (Sequential Scan)
SELECT * FROM events 
WHERE created_at > '2025-01-01';

-- âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾ (Index Scan + Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ñ†Ğ¸Ñ)
SELECT * FROM events_2025_01
WHERE created_at > '2025-01-01'
LIMIT 1000;

-- âœ… Ğ•Ñ‰Ğµ Ğ»ÑƒÑ‡ÑˆĞµ (Materialized View Ğ´Ğ»Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ¾Ğ²)
CREATE MATERIALIZED VIEW daily_metrics AS
SELECT 
  DATE_TRUNC('day', created_at) as date,
  COUNT(*) as total_events,
  COUNT(DISTINCT session_id) as sessions
FROM events
GROUP BY DATE_TRUNC('day', created_at);

-- ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€Ğ°Ğ· Ğ² Ñ‡Ğ°Ñ
REFRESH MATERIALIZED VIEW CONCURRENTLY daily_metrics;
```

---

## ğŸ”„ Data Flow

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ ĞºĞ»Ğ¸ĞºĞ°ĞµÑ‚ Ğ½Ğ° ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ"

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. EVENT: User clicks button                                â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ <button class="buy-btn">ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ</button>      â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CAPTURE: Click Tracker (Event Delegation)                â”‚
â”‚    document.body.addEventListener('click', (e) => {...})    â”‚
â”‚                                                              â”‚
â”‚    Collected Data:                                           â”‚
â”‚    - target: button.buy-btn                                  â”‚
â”‚    - text: "ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ"                                  â”‚
â”‚    - coordinates: {x: 450, y: 320}                          â”‚
â”‚    - timing: 45s since page load                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ENRICH: Add session context                              â”‚
â”‚    {                                                         â”‚
â”‚      session_id: "abc-123",                                 â”‚
â”‚      user_id: "user-456",                                   â”‚
â”‚      event_type: "click",                                   â”‚
â”‚      target_element: "button.buy-btn",                      â”‚
â”‚      target_text: "ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑĞµĞ¹Ñ‡Ğ°Ñ",                          â”‚
â”‚      payload: {                                             â”‚
â”‚        click: {x: 450, y: 320, button: 0},                 â”‚
â”‚        timing: {timeOnPage: 45000},                        â”‚
â”‚        viewport: {width: 1920, height: 1080}               â”‚
â”‚      }                                                       â”‚
â”‚    }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BUFFER: Add to event queue                               â”‚
â”‚    EventBatcher.push(event)                                 â”‚
â”‚    Buffer: [event1, event2, ...event10]                     â”‚
â”‚    Status: Buffer full â†’ trigger flush                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SEND: Batch POST to Supabase                             â”‚
â”‚    supabase.from('events').insert(buffer)                   â”‚
â”‚    Method: POST /rest/v1/events                             â”‚
â”‚    Headers: {apikey: ANON_KEY, Authorization: ...}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. VALIDATE: RLS Policy Check                               â”‚
â”‚    âœ“ Role: anon                                             â”‚
â”‚    âœ“ Operation: INSERT                                      â”‚
â”‚    âœ“ Policy: anon_insert_only_events â†’ ALLOW               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. STORE: Insert into PostgreSQL                            â”‚
â”‚    Table: events_2025_12 (automatic partition)              â”‚
â”‚    Indexes: Updated (session_id, created_at, GIN)          â”‚
â”‚    Triggers: Fire update_updated_at()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ANALYZE: Available for queries                           â”‚
â”‚    - Real-time dashboards (Retool)                          â”‚
â”‚    - ML predictions (MindsDB)                               â”‚
â”‚    - Ad-hoc SQL analysis                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Security Considerations

### 1. **API Key Exposure**
- âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ anon-key (Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹)
- âœ… Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒÑÑ‚ÑÑ Ñ‡ĞµÑ€ĞµĞ· RLS
- âœ… service_role ĞºĞ»ÑÑ‡ ĞĞ˜ĞšĞĞ“Ğ”Ğ Ğ½Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ĞµÑ‚ Ğ² frontend

### 2. **Data Injection**
- âœ… Supabase Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞºÑ€Ğ°Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ SQL
- âœ… Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ payload Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° (< 10 KB)
- âœ… CHECK constraints Ğ½Ğ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ

### 3. **Rate Limiting**
```javascript
// Supabase Edge Function Ğ´Ğ»Ñ rate limiting
import { createClient } from '@supabase/supabase-js'

export async function handler(req) {
  const ip = req.headers.get('x-forwarded-for')
  
  // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°: Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 100 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹/Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ IP
  const { count } = await supabase
    .from('events')
    .select('*', { count: 'exact', head: true })
    .eq('ip_address', ip)
    .gte('created_at', new Date(Date.now() - 60000).toISOString())
  
  if (count > 100) {
    return new Response('Rate limit exceeded', { status: 429 })
  }
  
  // Proceed with insert...
}
```

### 4. **GDPR Compliance**
```javascript
// Cookie Consent Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
if (!getCookieConsent()) {
  console.log('Analytics disabled: no consent');
  return;
}

// ĞœĞµÑ…Ğ°Ğ½Ğ¸Ğ·Ğ¼ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
async function deleteUserData(userId) {
  await supabase.from('events')
    .delete()
    .in('session_id', 
      supabase.from('sessions').select('session_id').eq('user_id', userId)
    );
  
  await supabase.from('sessions').delete().eq('user_id', userId);
  await supabase.from('users').delete().eq('user_id', userId);
}
```

---

## ğŸ“Š Scalability Plan

### Ğ¢ĞµĞºÑƒÑ‰Ğ°Ñ Ñ„Ğ°Ğ·Ğ° (MVP): < 10,000 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹/Ğ´ĞµĞ½ÑŒ
- âœ… Single Supabase instance
- âœ… Standard indexes
- âœ… Monthly partitions

### Ğ Ğ¾ÑÑ‚ (100,000 ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹/Ğ´ĞµĞ½ÑŒ):
- ğŸ”„ Enable connection pooling
- ğŸ”„ Add read replicas Ğ´Ğ»Ñ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ¾Ğ²
- ğŸ”„ Materialize Ñ‡Ğ°ÑÑ‚Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼Ñ‹Ğµ Ğ°Ğ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ğ¸

### Scale (1,000,000+ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹/Ğ´ĞµĞ½ÑŒ):
- ğŸ”„ Separate write/read databases
- ğŸ”„ TimescaleDB Ğ´Ğ»Ñ time-series Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
- ğŸ”„ ClickHouse Ğ´Ğ»Ñ Ñ…Ğ¾Ğ»Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ¸
- ğŸ”„ Kafka Ğ´Ğ»Ñ event streaming

---

## ğŸ”® Future Enhancements

1. **Server-side tracking** Ñ‡ĞµÑ€ĞµĞ· image pixel fallback
2. **Session replay** Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸ĞµĞ¼ DOM mutations
3. **Heatmaps** Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ĞºĞ»Ğ¸ĞºĞ¾Ğ² Ğ¸ ÑĞºÑ€Ğ¾Ğ»Ğ»Ğ¸Ğ½Ğ³Ğ°
4. **A/B testing** Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ğ°Ñ Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°
5. **Real-time alerts** Ñ‡ĞµÑ€ĞµĞ· Supabase Realtime
6. **Predictive analytics** Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ MindsDB
7. **Data warehouse** ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² BigQuery/Snowflake

---

**Ğ’ĞµÑ€ÑĞ¸Ñ**: 1.0.0  
**ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ**: 2025-12-22
