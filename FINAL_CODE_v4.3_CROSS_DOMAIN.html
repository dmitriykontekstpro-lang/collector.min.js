<!-- Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ¸ -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Tilda Analytics v4.3 (Cross-Domain Support) -->
<script>
    (function () {
        'use strict';
        window.TildaAnalytics = {
            config: null, supabase: null, state: { userId: null, currentSessionId: null, sessions: {}, events: new Set, goals: new Set, lastActivity: Date.now(), hasSynced: !1 }, _synced: !1, _syncTimer: null, _tickTimer: null,
            async init(e) {
                this.config = { supabaseUrl: "", supabaseKey: "", tableName: "analytics", minSessionDuration: 10, sessionTimeout: 12e5, syncInterval: 1e4, debug: !1, yandexMetrikaId: null, ...e },
                "undefined" != typeof supabase && (this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey), this._loadState(), this._checkSessionTimeout(), this._initTick(), this._initListeners(), this._decorateLinks(), // NEW: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð¼ÐµÑ‚ÐºÐ° ÑÑÑ‹Ð»Ð¾Ðº
                    this.config.yandexMetrikaId && this._initYandexMetrika(), this._log("ðŸš€ Init v4.3 Cross-Domain"), this.trackEvent("page_view"))
            },
            _loadState() {
                // 1. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸Ñ‰ÐµÐ¼ ID Ð² URL (ÐµÑÐ»Ð¸ Ð¿ÐµÑ€ÐµÑˆÐ»Ð¸ Ñ Ð´Ñ€ÑƒÐ³Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°)
                const urlParams = new URLSearchParams(window.location.search);
                let e = urlParams.get('ta_uid');

                // 2. Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð² URL, Ð¸Ñ‰ÐµÐ¼ Ð² LocalStorage
                if (!e) e = localStorage.getItem("ta_uid");

                // 3. Ð•ÑÐ»Ð¸ ÑÐ¾Ð²ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ - Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼
                e || (e = this._uuid()), localStorage.setItem("ta_uid", e);

                this.state.userId = e; try {
                    const t = JSON.parse(localStorage.getItem("ta_store") || "{}");
                    this.state.sessions = t.sessions || {}, this.state.events = new Set(t.events || []), this.state.goals = new Set(t.goals || []), this.state.lastActivity = t.lastActivity || Date.now(), this.state.currentSessionId = t.currentSessionId || null,
                        this.state.hasSynced = !!t.hasSynced
                } catch (e) { console.error(e) }
            },
            _saveState() { localStorage.setItem("ta_store", JSON.stringify({ sessions: this.state.sessions, events: Array.from(this.state.events), goals: Array.from(this.state.goals), lastActivity: this.state.lastActivity, currentSessionId: this.state.currentSessionId, hasSynced: this.state.hasSynced })) },
            _checkSessionTimeout() {
                const e = Date.now(); (!this.state.currentSessionId || e - this.state.lastActivity > this.config.sessionTimeout) && (this.state.currentSessionId = this._uuid(), this.state.sessions[this.state.currentSessionId] = 0,
                    this._log("ðŸ†• New Session:", this.state.currentSessionId)), this.state.lastActivity = e, this._saveState()
            },
            _initTick() { this._tickTimer = setInterval((() => { if (document.hidden) return; const e = this.state.currentSessionId; e && (this.state.sessions[e] = (this.state.sessions[e] || 0) + 1, this.state.lastActivity = Date.now(), this._saveState(), this._trySync()) }), 1e3) },
            async _trySync() {
                const e = this.state.currentSessionId, t = this.state.sessions[e] || 0, s = t < this.config.minSessionDuration;
                if (!this.state.hasSynced && s) return;
                if (!this._synced || !(Date.now() - this._lastSyncTime < this.config.syncInterval)) await this._syncToSupabase()
            },
            async _syncToSupabase() {
                const e = Object.values(this.state.sessions).reduce(((e, t) => e + t), 0), t = Object.keys(this.state.sessions).length, s = {
                    ua: navigator.userAgent, screen: `${window.screen.width}x${window.screen.height}`,
                    is_mobile: /Mobile|Android|iPhone/i.test(navigator.userAgent), language: navigator.language, timezone: Intl.DateTimeFormat().resolvedOptions().timeZone, referrer: document.referrer || null, entry_url: window.location.href, page_title: document.title,
                    total_time_sec: e, total_sessions_count: t, ...this._getUTM()
                }, i = Array.from(this.state.events).join(", "), n = Array.from(this.state.goals).join(", "),
                a = { user_id: this.state.userId, sessions_history: this.state.sessions, event_name: i, yandex_metrika: n, data: s, last_updated: (new Date).toISOString() };
                this._log("â¬†ï¸ Sync", a); const { error: r } = await this.supabase.from(this.config.tableName).upsert(a, { onConflict: "user_id" });
                r ? console.error("Sync fail", r) : (this._synced = !0, this.state.hasSynced = !0, this._saveState(), this._lastSyncTime = Date.now())
            },
            trackEvent(e) { this.state.events.add(e), this._saveState() }, trackGoal(e, t) { this.state.goals.add(e), this.trackEvent("yandex_goal"), this._saveState(), this._log("ðŸŽ¯ Metrika", e) },
            _initListeners() { document.addEventListener("click", (e => { e.target.closest('a, button, .t-btn, [role="button"]') && this.trackEvent("click") }), !0), document.addEventListener("submit", (() => this.trackEvent("form_submit"))) },
            _initYandexMetrika() { const e = window.ym; if (e) { window.ym = (...t) => { "reachGoal" === t[1] && this.trackGoal(t[2], t[3]), e(...t) } } },

            // NEW: Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¾Ð¼ÐµÑ‚ÐºÐ¸ Ð¸ÑÑ…Ð¾Ð´ÑÑ‰Ð¸Ñ… ÑÑÑ‹Ð»Ð¾Ðº
            _decorateLinks() {
                // Ð–Ð´ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ DOM
                setTimeout(() => {
                    const uid = this.state.userId;
                    if (!uid) return;
                    // Ð˜Ñ‰ÐµÐ¼ Ð²ÑÐµ ÑÑÑ‹Ð»ÐºÐ¸ Ð½Ð° Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ Ð´Ð¾Ð¼ÐµÐ½Ñ‹ (Wix/Tilda)
                    document.querySelectorAll('a').forEach(link => {
                        try {
                            const url = new URL(link.href);
                            // Ð•ÑÐ»Ð¸ ÑÑÑ‹Ð»ÐºÐ° Ð²ÐµÐ´ÐµÑ‚ Ð½Ð° Ð²Ð°ÑˆÐ¸ Ð´Ð¾Ð¼ÐµÐ½Ñ‹ (ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¸Ñ… Ñ‚ÑƒÑ‚ Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð²ÑÐµ Ð²Ð½ÐµÑˆÐ½Ð¸Ðµ)
                            if (url.hostname !== window.location.hostname) {
                                url.searchParams.set('ta_uid', uid);
                                link.href = url.toString();
                            }
                        } catch (e) { }
                    });
                }, 2000);
            },

            _getUTM() { const e = new URLSearchParams(window.location.search); return { utm_source: e.get("utm_source"), utm_medium: e.get("utm_medium"), utm_campaign: e.get("utm_campaign"), utm_content: e.get("utm_content") } },
            _uuid() { return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (e => { const t = 16 * Math.random() | 0; return ("x" == e ? t : 3 & t | 8).toString(16) })) },
            _log(...e) { this.config.debug && console.log("[TA v4.3]", ...e) }
        }
    })();
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        TildaAnalytics.init({
            supabaseUrl: 'https://qqfyjrugrinmdijpsutj.supabase.co',
            supabaseKey: 'sb_publishable_KzDns19CaSpI-40YZgPPCg_hCDb-1Iz',
            yandexMetrikaId: 51854510,
            debug: true
        });
    });
</script>